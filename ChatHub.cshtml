@{
    Layout = "~/_SiteLayout.cshtml";
    Page.Title = "ChatHub";
}

<head>
    <script src="Scripts/jquery-3.1.1.min.js"></script>
    <script src="Scripts/jquery.signalR-2.2.2.min.js"></script>
    <script src="signalR/hubs"></script>
    <link href="~/CSS/ChatHub.css" rel="stylesheet" type="text/css" />
</head>

<script>
    var chat = $.connection.chatHub;//chatHub小寫
    var name = "";

    //初始
    $(function () {
        name = window.prompt("Please Input Your NickName:");
    });

    //signalR啟動完成後，要執行的動作
    $.connection.hub.start().done(function () {

        //通知Server，有新使用者連進來
        chat.server.userConnected(name);

        //按傳送鈕
        $('#btnSend').click(function () {
            send();
        });
        //按Enter鍵
        $('#txtMsg').keydown(function (e) {
            if (e.which == 13) {
                send();
            }
        });

        //選取某一個使用者
        //★用 $("#lstUser li").click()會抓不到
        //★jQuery1.7以前建議使用$("#lstUser li").live("click",fn)
        //★jQuery1.7以後建議使用$(document).on("click", "#lstUser li",fn)
        $(document).on("click", "#lstUser li", function () {
            var name = $(this).html();
            var id = $(this).attr('id');

            $('#lblTalkToWho').html(name);
            $('#lblTalkToWhoId').html(id);
        });
    });

    //顯示訊息
    chat.client.show = function (message) {
        $('#chatRoom').append('<li>' + message + '</li>');
    };

    //顯示user清單
    chat.client.getList = function (users) {
        var li = "<li id=all>Public Channel</li>";
        $.each(users, function (i, user) {
            li += '<li id=' + user.id + ' >' + user.name + '</li>'
        });
        $('#lstUser').html(li);
    };

    //使用者離開
    chat.client.removeList = function (id) {
        $('#' + id).remove();
    };

    //傳送聊天內容至Server
    function send() {
        var id = $('#lblTalkToWhoId').text();

        if (id == "all") {
            chat.server.send($('#txtMsg').val());
        } else {
            chat.server.sendOne(id, $('#txtMsg').val());
        }

        $('#txtMsg').val('');
    }

</script>

<div class="container">
    <div class="row">
        <br>
        <div class="col-xs-6 col-sm-offset-0 col-sm-5">
            <div class="panel panel-default" style="height: 400px">
                <div class="panel-heading c-list">
                    <span class="title">Chat Room</span>
                </div>
                <ul id="chatRoom"></ul>
            </div>
        </div>

        <div class="col-xs-6 col-sm-offset-0 col-sm-3">
            <div class="panel panel-default" style="height: 400px">
                <div class="panel-heading c-list">
                    <span class="title">Online Contacts</span>
                </div>

                <ul class="list-group" id="contact-list">
                    <li class="list-group-item">
                        <ul id="lstUser">
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6 col-sm-offset-2 col-sm-5">
            Send To:
            <label id="lblTalkToWho">Public Channel</label>
            <label id="lblTalkToWhoId" hidden>all</label>
            <input id="txtMsg" type="text"/>
            <input id="btnSend" type="button" value="Send"/>
        </div>
    </div>
</div>
